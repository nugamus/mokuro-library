generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Series {
  id            String   @id @default(cuid())
  title         String?
  folderName    String
  coverPath     String?
  description   String?
  bookmarked    Boolean  @default(false)
  status        Int      @default(0)
  sortTitle     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  lastReadAt    DateTime @default(dbgenerated("'1970-01-01T00:00:00.000Z'"))
  ownerId       String
  japaneseTitle String?
  romajiTitle   String?
  synonyms      String?
  owner         User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  volumes       Volume[]

  @@unique([folderName, ownerId])
}

model Volume {
  id             String         @id @default(cuid())
  title          String?
  folderName     String
  pageCount      Int
  sortTitle      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt
  filePath       String         @unique
  mokuroPath     String         @unique
  coverImageName String?
  seriesId       String
  headPatchId    String?
  history        HistoryChunk[]
  progress       UserProgress[]
  series         Series         @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([seriesId, folderName])
}

model HistoryChunk {
  id              String   @id @default(uuid())
  volumeId        String
  previousChunkId String?
  startPatchId    String
  endPatchId      String
  payload         Bytes
  createdAt       DateTime @default(now())
  volume          Volume   @relation(fields: [volumeId], references: [id], onDelete: Cascade)

  @@index([volumeId, endPatchId])
}

model User {
  id       String         @id @default(cuid())
  username String         @unique
  password String
  settings Json
  uploads  Series[]
  progress UserProgress[]
}

model UserProgress {
  id         String   @id @default(cuid())
  page       Int      @default(1)
  timeRead   Int      @default(0)
  charsRead  Int      @default(0)
  completed  Boolean  @default(false)
  lastReadAt DateTime @default(dbgenerated("'1970-01-01T00:00:00.000Z'")) @updatedAt
  userId     String
  volumeId   String
  volume     Volume   @relation(fields: [volumeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, volumeId])
}
