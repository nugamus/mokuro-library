version: '3.8'
services:
  backend:
    container_name: mokuro-library-backend-dev

    # Target the 'backend-builder' stage from Dockerfile.
    # This stage has 'npm ci' run, so it includes all
    # devDependencies (like ts-node-dev).
    build:
      context: .
      target: backend-builder

    # Set the working directory to where 'npm run dev' should execute
    working_dir: /app/backend

    # Override the Dockerfile's CMD to run the 'dev' script
    command: npm run dev

    volumes:
      # Mount 'backend' folder to '/app/backend'
      # This lets ts-node-dev see code changes in real-time.
      - ./backend:/app/backend

      # Use the container's
      # /app/backend/node_modules and src/generated folder and ignore your
      # local host's node_modules (if any).
      - /app/backend/node_modules
      - /app/backend/src/generated

      - ./frontend/static/fonts:/app/frontend/static/fonts:ro

      - ./data:/app/data
      - ./data/uploads:/app/uploads

    environment:
      - NODE_ENV=development
      # This ensures the DATABASE_URL points to your persistent volume.
      - DATABASE_URL=file:/app/data/library.db
      # This polling setting is often required for file watching
      # to work correctly inside a Docker container.
      - CHOKIDAR_USEPOLLING=true

  frontend:
      container_name: mokuro-library-frontend-dev
      # Targets Stage 1 from Dockerfile
      build:
        context: .
        target: frontend-builder
        args:
          - COMMIT_HASH=${COMMIT_HASH:-dev}
      working_dir: /app/frontend
      # Runs 'vite dev --host'
      # The '--host' flag is required to access the dev server from your browser
      command: npm run dev -- --host
      volumes:
        - ./frontend:/app/frontend # Mounts your live frontend code
        - /app/frontend/node_modules # Uses the container's node_modules
      ports:
        - "5173:5173" # Exposes the Vite dev server port
      environment:
        - CHOKIDAR_USEPOLLING=true # Fixes file watching in Docker
        - VITE_PROXY_TARGET=http://backend:3001
      depends_on:
        - backend # Tells Docker to start the backend first
