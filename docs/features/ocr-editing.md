# Feature Spec: OCR Editing & Smart Resize

## 1. Overview & Goal
**Goal:** To provide a robust, browser-based editor for correcting OCR text and bounding boxes generated by the Mokuro tool.

**Philosophy:** Achieve full data parity with the source `.mokuro` file format and lay the groundwork for a future centralized, user-audited OCR database.
1.  **Data Integrity:** It ensures that saved files match the exact schema of machine-generated files, preventing data loss or "drift" during the editing process.
2.  **Future Infrastructure:** It standardizes the data format for human corrections, facilitating the creation of a shared, high-quality dataset that can eventually be used to train better OCR models or sync corrections across the community.

## 2. Technical Architecture

The editor uses a **Modal-State** architecture managed by `OcrState.svelte.ts`. The rendering strategy shifts based on the active mode to balance the requirements of **Extension Compatibility** (Reader) with **Data Manipulation** (Editor).

### 2.1. Rendering Strategies
The `OcrLine` component implements a "Dual-State" rendering engine:

| Mode | DOM Structure | Positioning Technique | Goal |
| :--- | :--- | :--- | :--- |
| **Reader (Default)** | `<span>` (Inline) | **Fake Absolute:** `relative` pos + negative margins | **Yomitan Compatibility.** Keeps text in a continuous stream for dictionary parsers while visually pinning lines to coordinates. |
| **Edit Mode** | `<div>` (Block) | **True Absolute:** `absolute` pos (`top`/`left`) | **Manipulation.** Allows dragging, resizing, and `contenteditable` focus without fighting browser flow. |

### 2.2. Data Model
The system relies on the standard `.mokuro` data structure, but treats `lines_coords` as the primary source of truth to maintain parity:
* **`block.box`**: The bounding container. Used for group selection and bulk moves.
* **`block.lines_coords`**: A 2D array of polygons `[lineIndex][cornerIndex][x,y]`. The editor renders each line based on these specific coordinates, ignoring standard line-height flow to preserve the original spatial data.

## 3. Interaction Modes

### 3.1. Text Edit Mode (`isEditMode`)
Enables direct string manipulation within the bubbles.
* **Focus:** Clicking a line creates a `contenteditable` div overlaid exactly on the text coordinates.
* **Line Operations:**
    * **Split (`Enter`):** Splits the current line at the caret position. The new line is automatically positioned below (horizontal) or to the left (vertical) of the original.
    * **Merge (`Backspace` at start):** Merges the current line into the previous line (`index - 1`), combining their text and deleting the current coordinate entry.
    * **Navigation:** `Arrow` keys move focus between adjacent lines within the block.

### 3.2. Box/Layout Mode (`isBoxEditMode`)
Enables geometry manipulation tools.
* **Dragging:**
    * **Block Drag:** Clicking the block body moves the *entire* group (`block.box` + all `lines_coords`).
    * **Line Drag:** Clicking a specific line moves only that line's coordinates (`lines_coords[i]`).
* **Resizing:**
    * **Handles:** 8-point resize handles available for both Blocks and Lines.
    * **Behavior:** Updates the underlying polygon coordinates in real-time.
    * **Smart Resize Integration:** If `isSmartResizeMode` is active, releasing a resize handle on a **Line** will immediately trigger a font size recalculation to fit the new box.

### 3.3. Smart Resize Mode (`isSmartResizeMode`)
A helper state that can be active alongside other modes.
* **Logic:** Uses a binary search approach to find the maximum `font-size` that fits the text within its defined `lines_coords` without overflowing.
* **Triggers:**
    1.  **On Blur:** When finishing a text edit.
    2.  **On Resize:** When finishing a line resize interaction.
    3.  **Manual:** Double-clicking a line while in this mode.

## 4. Persistence Strategy

* **State Mutation:** All drag/resize events mutate the reactive `ocrState` object in memory.
* **Coordinate Math:**
    * Screen deltas (pixels) are converted to **Image Coordinates** (original resolution) before being saved to the block.
    * This ensures edits remain accurate even if the user zooms in/out using the `Panzoom` engine.
* **Dirty Checking:** `ocrState.markDirty()` is called after every mutation (drag end, text input, split/merge), signalling the UI to enable the "Save" button.
